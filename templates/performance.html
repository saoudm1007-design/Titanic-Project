{% extends "base.html" %}

{% block title %}Model Performance - Titanic Survival Predictor Dashboard{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2 class="mb-3"><i class="bi bi-graph-up"></i> <span data-i18n="perf.title">Model Performance</span></h2>
        <p class="text-muted" data-i18n="perf.subtitle">Random Forest Classifier (200 trees, max depth 8)</p>
    </div>
</div>

<!-- Metric Cards -->
<div class="row g-3 mb-4">
    <div class="col-md-3 col-sm-6">
        <div class="card stat-card border-0 h-100">
            <div class="card-body text-center">
                <h6 class="text-muted" data-i18n="perf.accuracy">Accuracy</h6>
                <h2 class="metric-value text-primary">{{ (metrics.accuracy * 100) | round(1) }}%</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6">
        <div class="card stat-card border-0 h-100">
            <div class="card-body text-center">
                <h6 class="text-muted" data-i18n="perf.precision">Precision</h6>
                <h2 class="metric-value text-success">{{ (metrics.precision * 100) | round(1) }}%</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6">
        <div class="card stat-card border-0 h-100">
            <div class="card-body text-center">
                <h6 class="text-muted" data-i18n="perf.recall">Recall</h6>
                <h2 class="metric-value text-info">{{ (metrics.recall * 100) | round(1) }}%</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6">
        <div class="card stat-card border-0 h-100">
            <div class="card-body text-center">
                <h6 class="text-muted" data-i18n="perf.f1">F1 Score</h6>
                <h2 class="metric-value text-warning">{{ (metrics.f1_score * 100) | round(1) }}%</h2>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <!-- Confusion Matrix -->
    <div class="col-md-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <h6 class="card-title text-muted" data-i18n="perf.cm">Confusion Matrix</h6>
                <table class="table table-bordered text-center mt-3 confusion-matrix">
                    <thead>
                        <tr>
                            <th></th>
                            <th data-i18n="perf.pred_died">Predicted: Died</th>
                            <th data-i18n="perf.pred_survived">Predicted: Survived</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th data-i18n="perf.actual_died">Actual: Died</th>
                            <td class="table-success fw-bold">{{ metrics.confusion_matrix[0][0] }}</td>
                            <td class="table-danger">{{ metrics.confusion_matrix[0][1] }}</td>
                        </tr>
                        <tr>
                            <th data-i18n="perf.actual_survived">Actual: Survived</th>
                            <td class="table-danger">{{ metrics.confusion_matrix[1][0] }}</td>
                            <td class="table-success fw-bold">{{ metrics.confusion_matrix[1][1] }}</td>
                        </tr>
                    </tbody>
                </table>
                <div class="mt-3">
                    <p class="text-muted small mb-1">
                        <strong data-i18n="perf.cv_mean">CV Mean Accuracy</strong>: {{ (metrics.cv_mean * 100) | round(1) }}%
                        (&plusmn; {{ (metrics.cv_std * 100) | round(1) }}%)
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Feature Importance -->
    <div class="col-md-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <h6 class="card-title text-muted" data-i18n="perf.feature_imp">Feature Importance</h6>
                <canvas id="chart-feature-importance"></canvas>
            </div>
        </div>
    </div>

    <!-- Cross-Validation -->
    <div class="col-md-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <h6 class="card-title text-muted" data-i18n="perf.cv_scores">Cross-Validation Scores</h6>
                <canvas id="chart-cv-scores"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const metricsData = {{ metrics | tojson }};
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const featureLabels = Object.keys(metricsData.feature_importance);
    const featureValues = Object.values(metricsData.feature_importance);
    const barColors = featureValues.map((v, i) => {
        const hue = 210 - (i * 15);
        return `hsla(${hue}, 70%, 50%, 0.8)`;
    });

    new Chart(document.getElementById('chart-feature-importance'), {
        type: 'bar',
        data: {
            labels: featureLabels,
            datasets: [{
                label: 'Importance',
                data: featureValues,
                backgroundColor: barColors,
                borderWidth: 0
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                x: { beginAtZero: true, title: { display: true, text: 'Importance' } }
            }
        }
    });

    const cvScores = metricsData.cv_scores;
    const cvLabels = cvScores.map((_, i) => 'Fold ' + (i + 1));

    new Chart(document.getElementById('chart-cv-scores'), {
        type: 'bar',
        data: {
            labels: cvLabels,
            datasets: [{
                label: 'Accuracy',
                data: cvScores.map(s => (s * 100).toFixed(1)),
                backgroundColor: 'rgba(13, 110, 253, 0.7)',
                borderColor: 'rgba(13, 110, 253, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                y: {
                    beginAtZero: false,
                    min: Math.max(0, (Math.min(...cvScores) * 100) - 5),
                    max: 100,
                    title: { display: true, text: 'Accuracy (%)' }
                }
            }
        }
    });
});
</script>
{% endblock %}
